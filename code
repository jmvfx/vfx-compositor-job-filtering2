import pandas as pd

# ID de tu Google Sheet
sheet_id = "1eR2oAXOuflr8CZeGoz3JTrsgNj3KuefbdXJOmNtjEVM"
sheet_name = "Sheet1"

csv_url = f"https://docs.google.com/spreadsheets/d/{sheet_id}/gviz/tq?tqx=out:csv&sheet={sheet_name}"

df = pd.read_csv(csv_url)

# Filtrar filas que contengan "compositor"
mask = df.apply(lambda row: row.astype(str).str.lower().str.contains("compositor").any(), axis=1)
df_filtrado = df[mask].copy()
df_filtrado2 = df_filtrado.copy()

df_filtrado2.rename(
    columns={"Studio\n(Featured listings in blue)\n(Most recent in orange)": "Studio"},
    inplace=True
    
)
cols_unnamed = df_filtrado2.columns[df_filtrado2.columns.str.contains('^Unnamed', case=False)]
df_filtrado2.drop(cols_unnamed, axis=1, inplace=True)

EU_countries = [
    "Germany", "Austria", "Belgium", "Bulgaria", "Cyprus", "Croatia",
    "Denmark", "Slovakia", "Slovenia", "Spain", "Estonia", "Finland",
    "France", "Greece", "Hungary", "Ireland", "Italy", "Latvia",
    "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland",
    "Portugal", "Czech Republic", "Romania", "Sweden"
]

NonEU_countries = [
    "England",  "Canada", "Australia", "United States","Scotland","Wales",
]


Final = df_filtrado2.query(
    '(Country in @EU_countries or Country in @NonEU_countries) and '
    '(`Experience Level` in ["Mid", "Senior","Mid","Mid, Senior"])',
    engine="python"
)
Final.columns = ["Studio", "City", "Region", "Country","Job title","Level","Type","Date","Source","Software","Notes","Test","Region","11"]
cols_unnamed = df_filtrado2.columns[df_filtrado2.columns.str.contains('^Unnamed', case=False)]
Final=Final.drop(columns=["Test","Region","11","Notes"], axis=1)
Final= Final.reset_index()
del Final["index"]
Final
